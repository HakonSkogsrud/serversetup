---
- name: Create pihole VM
  hosts: proxmox
  become: false
  vars_files:
    - ../secrets.yml
  vars:
    target_vm_host: pihole2
  roles:
    - role: create_vm
      tags: create_vm
      vars:
        # Global Proxmox and template variables
        node: "{{ proxmox.node }}"
        api_user: "{{ proxmox.api_user }}"
        clone: "{{ template.name }}" #
        source_vmid_for_clone: "{{ template.vmid }}" 

        # VM-specific variables from hostvars/services.yml
        name: pihole
        newid: 4002
        ipaddr: 10.0.0.77
        balloon: 1500
        cores: 1
        memory: 2000
        sockets: 1
        primary_disk_size: 10G
        virtiofs_tag: "{{ virtiofs_tags.smb }}"


- name: Setup pihole vm
  hosts: pihole 
  become: true
  vars:
    ansible_host_key_checking: false
  vars_files:
    - ../secrets.yml
  roles:
    - role: pihole_setup
      tags: pihole_setup

    - role: pushover_config
      tags: pushover_config

    - role: tailnet_healthcheck
      tags: tailnet_healthcheck

    - role: weekly_update
      tags: weekly_update
    
    - role: weekly_reboot
      tags: weekly_reboot

    - role: tailscale_setup
      tags: tailscale_setup
      vars:
        tailscale_hostname: "{{ inventory_hostname }}"