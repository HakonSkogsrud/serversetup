name: Run Ansible Playbooks

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      playbook:
        description: 'Playbook to run'
        required: true
        type: choice
        options:
          - playbooks/backupserver.yml
          - playbooks/immich.yml
          - playbooks/pihole.yml
          - playbooks/proxmox.yml
          - playbooks/samba.yml
          - playbooks/services.yml
          - playbooks/subnet_router.yml

jobs:
  run-ansible:
    runs-on: self-hosted
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          pip install --upgrade ansible

      - name: Install Ansible Collections
        run: ansible-galaxy collection install community.docker community.general ansible.posix community.proxmox  --force

      
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
            ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Run Ansible Playbooks
        id: ansible_loop
        env:
          ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
          ANSIBLE_CONFIG: ./ansible.cfg
          ANSIBLE_HOST_KEY_CHECKING: "False"
          ANSIBLE_SSH_ARGS: "-o ControlMaster=auto -o ControlPersist=60s -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"
        shell: bash
        run: |
          # 1. Define List
          ALL_PLAYBOOKS=(
            "playbooks/backupserver.yml"
            "playbooks/immich.yml"
            "playbooks/pihole.yml"
            "playbooks/proxmox.yml"
            "playbooks/samba.yml"
            "playbooks/services.yml"
            "playbooks/subnet_router.yml"
          )

          # 2. Determine Targets
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
             TARGETS=("${{ github.event.inputs.playbook }}")
             echo "Manual run detected. Target: ${TARGETS[@]}"
          else
             TARGETS=("${ALL_PLAYBOOKS[@]}")
             echo "Push detected. Running ALL playbooks."
          fi

          # 3. Initialize Failure Tracking
          FAILED_LIST=()
          EXIT_CODE=0

          # 4. The Loop
          for playbook in "${TARGETS[@]}"; do
            echo "---------------------------------------------------"
            echo "üöÄ STARTING: $playbook"
            echo "---------------------------------------------------"
            
            # Run Ansible (allow failure)
            if ! ansible-playbook "$playbook" --vault-password-file <(echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}"); then
              echo "‚ùå FAILED: $playbook"
              FAILED_LIST+=("$playbook")
              EXIT_CODE=1
              # We do NOT exit here, we continue to the next item
            else
              echo "‚úÖ SUCCESS: $playbook"
            fi
          done

          # 5. Final Reporting
          if [ $EXIT_CODE -ne 0 ]; then
             # Join array with newlines for env var
             FAILED_STRING=$(IFS=$'\n'; echo "${FAILED_LIST[*]}")
             echo "FAILED_PLAYBOOKS<<EOF" >> $GITHUB_ENV
             echo "$FAILED_STRING" >> $GITHUB_ENV
             echo "EOF" >> $GITHUB_ENV
             
             echo "‚ö†Ô∏è  Failures detected in: ${FAILED_LIST[*]}"
             exit 1
          else
             echo "üéâ All playbooks passed successfully."
             exit 0
          fi

      - name: Notify success via Pushover
        if: success()
        run: |
          curl -s -X POST https://api.pushover.net/1/messages.json \
            -F "token=${{ secrets.PUSHOVER_APP_TOKEN }}" \
            -F "user=${{ secrets.PUSHOVER_USER_TOKEN }}" \
            -F "title=Ansible Deployment Success" \
            -F "message=All tasks completed successfully on ${{ github.ref_name }}" \
            -F "priority=0" \
            -F "sound=pushover"
      
      - name: Notify failure via Pushover
        if: failure()
        run: |
          # Retrieve the list of failed files from ENV
          FAILED_FILES="${{ env.FAILED_PLAYBOOKS }}"
          
          if [[ -z "$FAILED_FILES" ]]; then
             FAILED_FILES="Unknown Error (Script crashed before Ansible)"
          fi

          # Format message to show list
          MSG="The following playbooks failed on ${{ github.ref_name }}:
          $FAILED_FILES"

          curl -s -X POST https://api.pushover.net/1/messages.json \
            -F "token=${{ secrets.PUSHOVER_APP_TOKEN }}" \
            -F "user=${{ secrets.PUSHOVER_USER_TOKEN }}" \
            -F "title=Ansible Deployment Failed" \
            -F "message=$MSG" \
            -F "priority=1" \
            -F "sound=siren"