name: Deploy to Homelab
on:
  push:
    branches: [main]
    paths:
      - "**.yml"
      - "**.yaml"
      - "inventory/**"

  workflow_dispatch:

jobs:
  run-ansible:
    runs-on: self-hosted
    env:
      ANSIBLE_CONFIG: ./ansible.cfg
      ANSIBLE_HOST_KEY_CHECKING: "False"
      ANSIBLE_SSH_ARGS: "-o ControlMaster=auto -o ControlPersist=60s -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"
      ANSIBLE_FORCE_COLOR: "true"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean previous run artifacts
        run: |
          rm -rf ~/.ansible/collections/ansible_collections/{community,ansible}
          rm -rf ~/.ansible/tmp/*
          rm -rf /tmp/ansible-*
          # Kill any hanging ansible-galaxy processes
          pkill -9 -f ansible-galaxy || true


      - name: Install Python dependencies
        run: pip3.12 install -r requirements.txt

      - name: Install Ansible Collections
        run: |
          ansible-galaxy collection install -r requirements-collections.yml --force
        timeout-minutes: 5

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Run Backupserver
        run: ansible-playbook playbooks/backupserver.yml --vault-password-file <(echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}")

      - name: Run Immich
        run: ansible-playbook playbooks/immich.yml --vault-password-file <(echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}") -e "force_recreate=true"

      - name: Run Pihole
        run: ansible-playbook playbooks/pihole.yml --vault-password-file <(echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}") -e "force_recreate=true"

      - name: Run Pihole-secondary
        run: ansible-playbook playbooks/pihole_secondary.yml --vault-password-file <(echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}") -e "force_recreate=true"

      - name: Run Proxmox
        run: ansible-playbook playbooks/proxmox.yml --vault-password-file <(echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}")

      - name: Run Proxmox2
        run: ansible-playbook playbooks/proxmox2.yml --vault-password-file <(echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}")

      - name: Run Samba
        run: ansible-playbook playbooks/samba.yml --vault-password-file <(echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}") -e "force_recreate=true"

      - name: Run Services
        run: ansible-playbook playbooks/services.yml --vault-password-file <(echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}") -e "force_recreate=true"

      - name: Run Subnet Router
        run: ansible-playbook playbooks/subnet_router.yml --vault-password-file <(echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}") -e "force_recreate=true"

      - name: Run Subnet Router secondary
        run: ansible-playbook playbooks/subnet_router_secondary.yml --vault-password-file <(echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}") -e "force_recreate=true"

      - name: Loki
        run: ansible-playbook playbooks/loki.yml --vault-password-file <(echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}") -e "force_recreate=true"

      - name: Grafana
        run: ansible-playbook playbooks/grafana.yml --vault-password-file <(echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}") -e "force_recreate=true"

      - name: Notify success via Pushover
        if: success()
        run: |
          curl -s -X POST https://api.pushover.net/1/messages.json \
            -F "token=${{ secrets.PUSHOVER_APP_TOKEN }}" \
            -F "user=${{ secrets.PUSHOVER_USER_TOKEN }}" \
            -F "title=Ansible Deployment Success" \
            -F "message=Successfully deployed playbooks to homelab!" \
            -F "priority=0" \
            -F "sound=bugle"

      - name: Notify failure via Pushover
        if: failure()
        run: |
          curl -s -X POST https://api.pushover.net/1/messages.json \
            -F "token=${{ secrets.PUSHOVER_APP_TOKEN }}" \
            -F "user=${{ secrets.PUSHOVER_USER_TOKEN }}" \
            -F "title=Ansible Deployment Failed" \
            -F "message=Deployment failed. Check GitHub Actions logs for details." \
            -F "priority=0" \
            -F "sound=siren"
