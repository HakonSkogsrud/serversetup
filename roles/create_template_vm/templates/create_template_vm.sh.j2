#!/bin/bash
#
# AlmaLinux Cloud Template VM Creator
# Downloads the latest AlmaLinux Cloud image (if checksum differs),
# destroys any existing template VM, and recreates it from the new image.
# Logs to systemd journal for Grafana/Loki.
# This script is managed by Ansible.

SCRIPT_NAME="{{ create_template_vm_script_name }}"

# --- Variables ---
VMID="{{ template.vmid }}"
IMAGE_NAME="{{ template.name }}"
USER="{{ template.user }}"
VM_PASSWORD="{{ vm_password }}"
GATEWAY="{{ gateway }}"
STORAGE="{{ create_template_vm_storage }}"
SEARCH_DOMAIN="{{ create_template_vm_template_search_domain }}"

IMAGE_URL="{{ create_template_vm_alma_image_url }}"
IMAGE_FILENAME="{{ create_template_vm_alma_image_filename }}"
IMAGE_DOWNLOAD_PATH="{{ create_template_vm_image_download_path }}"
IMAGE_FILE="${IMAGE_DOWNLOAD_PATH}/${IMAGE_FILENAME}"
CHECKSUM_CACHE_FILE="{{ create_template_vm_checksum_cache_file }}"

# Checksum URL (AlmaLinux provides CHECKSUM file in same directory)
CHECKSUM_URL="{{ create_template_vm_alma_checksum_url }}"

# --- Functions ---

get_remote_checksum() {
    logger -t "$SCRIPT_NAME" -p user.info "Fetching remote checksum from ${CHECKSUM_URL}"
    local checksum_content
    checksum_content=$(curl -sL "$CHECKSUM_URL" 2>/dev/null)
    if [[ $? -ne 0 ]] || [[ -z "$checksum_content" ]]; then
        logger -t "$SCRIPT_NAME" -p user.err "Failed to fetch remote checksum"
        return 1
    fi

    # Extract SHA256 checksum for the specific image file
    # AlmaLinux CHECKSUM format: "SHA256 (filename) = checksum"
    local checksum
    checksum=$(echo "$checksum_content" | grep "SHA256 (${IMAGE_FILENAME})" | awk '{print $4}')

    if [[ -z "$checksum" ]]; then
        # Try alternative format: "checksum  filename"
        checksum=$(echo "$checksum_content" | grep "${IMAGE_FILENAME}" | awk '{print $1}')
    fi

    if [[ -z "$checksum" ]]; then
        logger -t "$SCRIPT_NAME" -p user.err "Could not extract checksum for ${IMAGE_FILENAME}"
        return 1
    fi

    echo "$checksum"
}

get_cached_checksum() {
    if [[ -f "$CHECKSUM_CACHE_FILE" ]]; then
        cat "$CHECKSUM_CACHE_FILE"
    else
        echo ""
    fi
}

save_checksum() {
    local checksum="$1"
    echo "$checksum" > "$CHECKSUM_CACHE_FILE"
}

download_image() {
    logger -t "$SCRIPT_NAME" -p user.info "Downloading AlmaLinux Cloud image from ${IMAGE_URL}"
    mkdir -p "$IMAGE_DOWNLOAD_PATH"

    if ! curl -L -o "$IMAGE_FILE" "$IMAGE_URL" 2>&1 | logger -t "$SCRIPT_NAME" -p user.info; then
        logger -t "$SCRIPT_NAME" -p user.err "Failed to download AlmaLinux Cloud image"
        return 1
    fi

    logger -t "$SCRIPT_NAME" -p user.info "Download completed: ${IMAGE_FILE}"
    return 0
}

verify_download() {
    local expected_checksum="$1"
    logger -t "$SCRIPT_NAME" -p user.info "Verifying downloaded image checksum"

    local actual_checksum
    actual_checksum=$(sha256sum "$IMAGE_FILE" | awk '{print $1}')

    if [[ "$actual_checksum" != "$expected_checksum" ]]; then
        logger -t "$SCRIPT_NAME" -p user.err "Checksum verification failed! Expected: ${expected_checksum}, Got: ${actual_checksum}"
        return 1
    fi

    logger -t "$SCRIPT_NAME" -p user.info "Checksum verification passed"
    return 0
}

destroy_existing_template() {
    logger -t "$SCRIPT_NAME" -p user.info "Checking for existing template VM ${VMID}"

    if qm status "$VMID" &>/dev/null; then
        logger -t "$SCRIPT_NAME" -p user.info "Destroying existing template VM ${VMID}"
        if ! qm destroy "$VMID" --purge; then
            logger -t "$SCRIPT_NAME" -p user.err "Failed to destroy existing template VM ${VMID}"
            return 1
        fi
        logger -t "$SCRIPT_NAME" -p user.info "Existing template VM destroyed"
    else
        logger -t "$SCRIPT_NAME" -p user.info "No existing template VM found with ID ${VMID}"
    fi
    return 0
}

create_template_vm() {
    logger -t "$SCRIPT_NAME" -p user.info "Creating new template VM ${VMID} with name ${IMAGE_NAME}"

    # Create VM structure
    if ! qm create "$VMID" --name "$IMAGE_NAME" --memory 4096 --net0 virtio,bridge=vmbr0 --agent 1; then
        logger -t "$SCRIPT_NAME" -p user.err "Failed to create VM ${VMID}"
        return 1
    fi

    # Import disk
    logger -t "$SCRIPT_NAME" -p user.info "Importing disk from ${IMAGE_FILE}"
    if ! qm importdisk "$VMID" "$IMAGE_FILE" "$STORAGE"; then
        logger -t "$SCRIPT_NAME" -p user.err "Failed to import disk for VM ${VMID}"
        qm destroy "$VMID" --purge 2>/dev/null
        return 1
    fi

    # Hardware Settings
    logger -t "$SCRIPT_NAME" -p user.info "Configuring hardware settings"
    qm set "$VMID" --scsihw virtio-scsi-single
    qm set "$VMID" --scsi0 "${STORAGE}:vm-${VMID}-disk-0,discard=on,iothread=1,ssd=1,cache=none"
    qm set "$VMID" --ide2 "${STORAGE}:cloudinit"
    qm set "$VMID" --boot c --bootdisk scsi0
    qm set "$VMID" --serial0 socket
    qm set "$VMID" --cpu host
    qm set "$VMID" --numa 1

    # Cloud-Init Settings
    logger -t "$SCRIPT_NAME" -p user.info "Configuring Cloud-Init settings"
    qm set "$VMID" --ciuser "$USER"
    qm set "$VMID" --cipassword "$VM_PASSWORD"
    qm set "$VMID" --sshkeys /root/.ssh/authorized_keys
    qm set "$VMID" --ipconfig0 ip=dhcp

    # DNS Settings
    qm set "$VMID" --nameserver "$GATEWAY"
    qm set "$VMID" --searchdomain "$SEARCH_DOMAIN"

    # Convert to Template
    logger -t "$SCRIPT_NAME" -p user.info "Converting VM to template"
    if ! qm template "$VMID"; then
        logger -t "$SCRIPT_NAME" -p user.err "Failed to convert VM ${VMID} to template"
        return 1
    fi

    logger -t "$SCRIPT_NAME" -p user.info "Template VM ${VMID} created successfully"
    return 0
}

# --- Main Script ---

logger -t "$SCRIPT_NAME" -p user.info "Starting AlmaLinux Cloud template VM creation script"

# Step 1: Get remote checksum
remote_checksum=$(get_remote_checksum)
if [[ $? -ne 0 ]] || [[ -z "$remote_checksum" ]]; then
    logger -t "$SCRIPT_NAME" -p user.err "Failed to retrieve remote checksum"
    exit 1
fi
logger -t "$SCRIPT_NAME" -p user.info "Remote checksum: ${remote_checksum}"

# Step 2: Compare with cached checksum
cached_checksum=$(get_cached_checksum)
logger -t "$SCRIPT_NAME" -p user.info "Cached checksum: ${cached_checksum:-none}"

if [[ "$remote_checksum" == "$cached_checksum" ]]; then
    logger -t "$SCRIPT_NAME" -p user.info "Checksums match - no update needed"
    exit 0
fi

logger -t "$SCRIPT_NAME" -p user.info "Checksum changed - proceeding with template update"

# Step 3: Download new image
if ! download_image; then
    exit 1
fi

# Step 4: Verify download
if ! verify_download "$remote_checksum"; then
    rm -f "$IMAGE_FILE"
    exit 1
fi

# Step 5: Destroy existing template
if ! destroy_existing_template; then
    exit 1
fi

# Step 6: Create new template VM
if ! create_template_vm; then
    exit 1
fi

# Step 7: Save new checksum to cache
save_checksum "$remote_checksum"
logger -t "$SCRIPT_NAME" -p user.info "Checksum cached for future comparisons"

logger -t "$SCRIPT_NAME" -p user.info "Template VM creation script completed successfully"
