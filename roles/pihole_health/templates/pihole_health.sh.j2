#!/bin/bash
#
# Monitors Pi-hole DNS functionality and ad blocking.
# Logs to systemd journal and sends Pushover alerts on failure.
# This script is managed by Ansible.

SCRIPT_NAME="{{ pihole_health_script_name }}"

# Pi-hole servers to check
PIHOLE_MAIN="{{ pihole_health_main_ip }}"
PIHOLE_BACKUP="{{ pihole_health_backup_ip }}"

# Domains for testing
PUBLIC_DOMAIN="google.com"
BLOCKED_DOMAIN="flurry.com"

# Source pushover library
if [ -f /usr/local/lib/send_pushover.sh ]; then
    source /usr/local/lib/send_pushover.sh
fi

# Check a single Pi-hole instance
check_pihole() {
    local pihole_ip=$1
    local pihole_name=$2
    local status_message=""
    local overall_status="HEALTHY"

    # Check 1: Public domain resolution
    public_ip=$(/usr/bin/dig @"$pihole_ip" +short "$PUBLIC_DOMAIN")

    if [ -z "$public_ip" ] || [ "$public_ip" == "0.0.0.0" ]; then
        status_message+="Public DNS FAILED. "
        overall_status="UNHEALTHY"
        logger -t "$SCRIPT_NAME" -p user.err "PIHOLE_DNS_FAILED - $pihole_name ($pihole_ip) cannot resolve public domains"
    fi

    # Check 2: Ad blocking
    blocked_ip=$(/usr/bin/dig @"$pihole_ip" +short "$BLOCKED_DOMAIN")

    if [ "$blocked_ip" != "0.0.0.0" ]; then
        status_message+="Ad blocking FAILED. "
        overall_status="UNHEALTHY"
        logger -t "$SCRIPT_NAME" -p user.err "PIHOLE_BLOCKING_FAILED - $pihole_name ($pihole_ip) is not blocking ads properly"
    fi

    # Send Pushover alert if unhealthy
    if [ "$overall_status" != "HEALTHY" ]; then
        logger -t "$SCRIPT_NAME" -p user.err "PIHOLE_UNHEALTHY - $pihole_name ($pihole_ip) health check failed: $status_message"
        send_pushover "${pushover_pihole:-}" "Pi-hole Alert: $pihole_name ($pihole_ip) is UNHEALTHY. $status_message" "Pi-hole Monitoring" 0 "siren"
    else
        logger -t "$SCRIPT_NAME" -p user.info "PIHOLE_HEALTHY - $pihole_name ($pihole_ip) is functioning correctly"
    fi
}

# Check both Pi-hole instances
check_pihole "$PIHOLE_MAIN" "Main Pi-hole"
check_pihole "$PIHOLE_BACKUP" "Backup Pi-hole"
