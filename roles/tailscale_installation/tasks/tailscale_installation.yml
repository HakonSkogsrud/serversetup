---
- name: Download Tailscale install script
  ansible.builtin.get_url:
    url: https://tailscale.com/install.sh
    dest: /tmp/install.sh
    mode: "0755"

- name: Run Tailscale install script
  block:
    - name: Run Tailscale install script
      ansible.builtin.command: bash -o pipefail /tmp/install.sh
      changed_when: true
      register: tailscale_installation_result
  rescue:
    - name: Clean APT cache on failure
      ansible.builtin.apt:
        clean: true
      when: ansible_facts['os_family'] == "Debian"

    - name: Update APT cache after cleaning
      ansible.builtin.apt:
        update_cache: true
      when: ansible_facts['os_family'] == "Debian"

    - name: Retry Tailscale install script after cache cleanup
      ansible.builtin.command: bash -o pipefail /tmp/install.sh
      changed_when: true

- name: Ensure Tailscale is enabled and started (systemd)
  ansible.builtin.systemd:
    name: tailscaled
    enabled: true
    state: started
