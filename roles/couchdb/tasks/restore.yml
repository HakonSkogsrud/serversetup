---
- name: Check if backup file exists on controller
  ansible.builtin.stat:
    path: "/tmp/couchdb-backup.tar.gz"
  delegate_to: localhost
  become: false
  register: couchdb_controller_backup

- name: Check if backup file exists on storage
  ansible.builtin.stat:
    path: "{{ couchdb_backup_path }}/couchdb-backup.tar.gz"
  register: couchdb_storage_backup

- name: Set backup source fact
  ansible.builtin.set_fact:
    couchdb_backup_source: >-
      {{ '/tmp/couchdb-backup.tar.gz' if couchdb_controller_backup.stat.exists
         else (couchdb_backup_path ~ '/couchdb-backup.tar.gz') if couchdb_storage_backup.stat.exists
         else '' }}
    couchdb_backup_is_remote: "{{ couchdb_storage_backup.stat.exists and not couchdb_controller_backup.stat.exists }}"

- name: Restore CouchDB data
  when: couchdb_backup_source != ''
  block:
    - name: Copy backup from controller to remote
      ansible.builtin.copy:
        src: "{{ couchdb_backup_source }}"
        dest: "/tmp/couchdb-backup.tar.gz"
        mode: "0644"
      when: not couchdb_backup_is_remote | bool

    - name: Copy backup from storage to temp (remote_src)
      ansible.builtin.copy:
        src: "{{ couchdb_backup_source }}"
        dest: "/tmp/couchdb-backup.tar.gz"
        mode: "0644"
        remote_src: true
      when: couchdb_backup_is_remote | bool

    - name: Ensure CouchDB storage data directory exists
      ansible.builtin.file:
        path: "{{ couchdb_storage_path }}/data"
        state: directory
        mode: "0755"
        owner: "{{ template.user }}"
        group: "{{ template.user }}"
      become: true

    - name: Extract backup to CouchDB storage directory
      ansible.builtin.unarchive:
        src: "/tmp/couchdb-backup.tar.gz"
        dest: "{{ couchdb_storage_path }}"
        remote_src: true
        owner: "{{ template.user }}"
        group: "{{ template.user }}"
      become: true

    - name: Copy backup to persistent storage
      ansible.builtin.copy:
        src: "/tmp/couchdb-backup.tar.gz"
        dest: "{{ couchdb_backup_path }}/couchdb-backup.tar.gz"
        mode: "0644"
        remote_src: true
      when: not couchdb_backup_is_remote | bool

    - name: Clean up temp restore file
      ansible.builtin.file:
        path: "/tmp/couchdb-backup.tar.gz"
        state: absent
