---
- name: Check if CouchDB data directory exists
  ansible.builtin.stat:
    path: "{{ couchdb_storage_path }}/data"
  register: couchdb_data_exists

- name: Backup CouchDB databases
  when: couchdb_data_exists.stat.exists
  block:
    - name: Create backup archive of CouchDB data
      community.general.archive:
        path: "{{ couchdb_storage_path }}/data"
        dest: "/tmp/couchdb-backup.tar.gz"
        format: gz
        mode: "0644"
      become: true

    - name: Fetch backup to controller
      ansible.builtin.fetch:
        src: "/tmp/couchdb-backup.tar.gz"
        dest: "/tmp/couchdb-backup.tar.gz"
        flat: true

    - name: Clean up temp backup file on remote
      ansible.builtin.file:
        path: "/tmp/couchdb-backup.tar.gz"
        state: absent
