---
- name: Check if backup file exists on controller
  ansible.builtin.stat:
    path: "/tmp/pihole-teleporter-latest.zip"
  delegate_to: localhost
  become: false
  register: pihole_controller_backup

- name: Check if backup file exists on storage
  ansible.builtin.stat:
    path: "{{ pihole_backup_path }}/pihole-teleporter-latest.zip"
  register: pihole_storage_backup

- name: Set backup source fact
  ansible.builtin.set_fact:
    pihole_backup_source: >-
      {{ '/tmp/pihole-teleporter-latest.zip' if pihole_controller_backup.stat.exists
         else (pihole_backup_path ~ '/pihole-teleporter-latest.zip') if pihole_storage_backup.stat.exists
         else '' }}
    pihole_backup_is_remote: "{{ pihole_storage_backup.stat.exists and not pihole_controller_backup.stat.exists }}"

- name: Fail if no backup file found
  ansible.builtin.fail:
    msg: "No backup file found on controller (/tmp/) or storage ({{ pihole_backup_path }}/)"
  when: pihole_backup_source == ''

- name: Copy backup from controller to remote
  ansible.builtin.copy:
    src: "{{ pihole_backup_source }}"
    dest: "/tmp/restore.zip"
    mode: "0644"
  when: not pihole_backup_is_remote | bool

- name: Copy backup from storage to temp (remote_src)
  ansible.builtin.copy:
    src: "{{ pihole_backup_source }}"
    dest: "/tmp/restore.zip"
    mode: "0644"
    remote_src: true
  when: pihole_backup_is_remote | bool

- name: Copy backup to persistent storage
  ansible.builtin.copy:
    src: "/tmp/restore.zip"
    dest: "{{ pihole_backup_path }}/pihole-teleporter-latest.zip"
    mode: "0644"
    remote_src: true
  when: not pihole_backup_is_remote | bool

- name: Restore configuration from Teleporter backup (v6)
  ansible.builtin.command: "pihole-FTL --teleporter /tmp/restore.zip"
  become: true
  register: pihole_restore_result
  changed_when: "'Restoring' in pihole_restore_result.stdout"

- name: Update Gravity to apply imported lists
  ansible.builtin.command: "/usr/local/bin/pihole -g"
  become: true
  changed_when: false

- name: Clean up temp restore file
  ansible.builtin.file:
    path: "/tmp/restore.zip"
    state: absent
