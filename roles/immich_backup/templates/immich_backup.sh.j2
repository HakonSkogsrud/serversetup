#!/bin/bash
#
# Immich backup script: dumps database and syncs data to SMB share.
# Logs to systemd journal for Grafana/Loki.
# This script is managed by Ansible.

SCRIPT_NAME="{{ immich_backup_script_name }}"
BACKUP_DEST_DIR="/mnt/storage/smb/immich_backup"
POSTGRES_CONTAINER="immich_postgres"
PROJECT_DIR="{{ immich_backup_project_dir }}"

logger -t "$SCRIPT_NAME" -p user.info "Starting Immich backup"

# Ensure backup destination exists
mkdir -p "$BACKUP_DEST_DIR/data"

# Change to project directory
cd "$PROJECT_DIR" || { logger -t "$SCRIPT_NAME" -p user.err "Failed to change to project directory: $PROJECT_DIR"; exit 1; }

# Start services if not running
logger -t "$SCRIPT_NAME" -p user.info "Ensuring services are running for DB dump"
docker compose up -d || { logger -t "$SCRIPT_NAME" -p user.err "Failed to start services"; exit 1; }

# Give services time to initialize
sleep 5

# Dump database
logger -t "$SCRIPT_NAME" -p user.info "Dumping database"
docker exec -t "$POSTGRES_CONTAINER" pg_dumpall --clean --if-exists --username=postgres | gzip > "$BACKUP_DEST_DIR/immich_db.sql.gz"
if [ "${PIPESTATUS[0]}" -ne 0 ]; then
    logger -t "$SCRIPT_NAME" -p user.err "Database dump failed"
    docker compose up -d  # Try to restart services
    exit 1
fi

# Stop services for consistent data sync
logger -t "$SCRIPT_NAME" -p user.info "Stopping services for data sync"
docker compose down || logger -t "$SCRIPT_NAME" -p user.warning "Failed to stop services cleanly"

# Sync data
logger -t "$SCRIPT_NAME" -p user.info "Syncing data folders"
rsync -avh --delete \
    --exclude 'postgres' \
    --exclude 'library/backups' \
    . "$BACKUP_DEST_DIR/data/"
RSYNC_STATUS=$?

# Restart services
logger -t "$SCRIPT_NAME" -p user.info "Restarting services"
docker compose up -d || logger -t "$SCRIPT_NAME" -p user.err "CRITICAL: Failed to restart services"

if [ $RSYNC_STATUS -ne 0 ]; then
    logger -t "$SCRIPT_NAME" -p user.err "Data sync failed"
    exit 1
fi

logger -t "$SCRIPT_NAME" -p user.info "Backup completed successfully"
