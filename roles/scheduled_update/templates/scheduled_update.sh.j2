#!/bin/bash
#
# Scheduled system package updates with service restart handling.
# Logs to systemd journal for Grafana/Loki.
# This script is managed by Ansible.

SCRIPT_NAME="{{ scheduled_update_script_name }}"

# Function to restart service if it needs updating
restart_service_if_needed() {
    local service_pattern="$1"
    local service_name=$(systemctl list-units "$service_pattern" --state=running --no-legend 2>/dev/null | awk '{print $1}' | head -n1)

    if [ -z "$service_name" ]; then
        return
    fi

    logger -t "$SCRIPT_NAME" -p user.info "Checking if $service_name needs restart..."

    if command -v needs-restarting >/dev/null 2>&1; then
        if needs-restarting -s 2>/dev/null | grep -q "$service_name"; then
            logger -t "$SCRIPT_NAME" -p user.info "Restarting $service_name after update..."
            systemctl restart "$service_name" && \
                logger -t "$SCRIPT_NAME" -p user.info "Successfully restarted $service_name" || \
                logger -t "$SCRIPT_NAME" -p user.warning "Failed to restart $service_name"
        fi
    elif command -v needrestart >/dev/null 2>&1; then
        if needrestart -b 2>/dev/null | grep -q "NEEDRESTART-SVC: $service_name"; then
            logger -t "$SCRIPT_NAME" -p user.info "Restarting $service_name after update..."
            systemctl restart "$service_name" && \
                logger -t "$SCRIPT_NAME" -p user.info "Successfully restarted $service_name" || \
                logger -t "$SCRIPT_NAME" -p user.warning "Failed to restart $service_name"
        fi
    else
        # Fallback: restart as precaution if tools unavailable
        logger -t "$SCRIPT_NAME" -p user.info "Restarting $service_name as precaution..."
        systemctl restart "$service_name"
    fi
}

logger -t "$SCRIPT_NAME" -p user.info "Starting package update"

# Run updates based on package manager
if command -v apt-get >/dev/null 2>&1; then
    apt-get update -y && apt-get upgrade -y
    UPDATE_STATUS=$?
elif command -v dnf >/dev/null 2>&1; then
    dnf upgrade -y
    UPDATE_STATUS=$?
else
    logger -t "$SCRIPT_NAME" -p user.err "No supported package manager found"
    exit 1
fi

if [ $UPDATE_STATUS -ne 0 ]; then
    logger -t "$SCRIPT_NAME" -p user.err "Package update failed"
    exit 1
fi

logger -t "$SCRIPT_NAME" -p user.info "Package update completed successfully"

# Restart services if needed
restart_service_if_needed "tailscaled.service"
restart_service_if_needed "syncthing@*.service"

logger -t "$SCRIPT_NAME" -p user.info "Script finished"
