#!/bin/bash
LOG_FILE="/var/log/pihole_gravity_update.log"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

touch "$LOG_FILE" 2>/dev/null || { echo "Warning: Could not access $LOG_FILE. Logging may fail." >&2; }

log "Starting Pi-hole update."

if [ -f /usr/local/lib/send_pushover.sh ]; then
    source /usr/local/lib/send_pushover.sh
    log "Pushover script sourced."
else
    log "Pushover script not found at /usr/local/lib/send_pushover.sh. Notifications will be skipped."
    send_pushover() {
        log "Pushover notification not sent because send_pushover.sh is missing."
    }
fi

if sudo /usr/local/bin/pihole -up >> "$LOG_FILE" 2>&1; then
    log "Pi-hole update completed successfully."
    send_pushover "${pushover_gravity:-}" "Pi-hole update completed successfully on $(hostname)." "Pi-hole Update" 0 "bike"
    log "Success notification sent."
else
    log "Pi-hole update FAILED."
    send_pushover "${pushover_gravity:-}" "Pi-hole update FAILED on $(hostname). Check log file $LOG_FILE for details." "Pi-hole Update FAILED" 0 "siren"
    log "Failure notification sent."
    exit 1
fi

log "Pi-hole update script finished."
