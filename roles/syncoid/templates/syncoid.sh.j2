#!/bin/bash
#
# Syncoid ZFS backup script: syncs datasets to remote backup server.
# Logs to systemd journal for Grafana/Loki.
# This script is managed by Ansible.

SCRIPT_NAME="{{ syncoid_script_name }}"
LOCK_FILE="/var/run/syncoid-backup.lock"
REMOTE_USER="root"
REMOTE_HOST="{{ vms.backupserver.ip }}"
POSSIBLE_POOLS=("wdred" "sgblack")
PROXMOX_DATASET="storage"
BACKUP_DATASET="backup"
DATASETS_TO_BACKUP=("smb")

ZFS="/usr/sbin/zfs"
ZPOOL="/usr/sbin/zpool"

# Function to acquire lock
acquire_lock() {
    if [ -f "$LOCK_FILE" ]; then
        local lock_pid=$(cat "$LOCK_FILE")
        if kill -0 "$lock_pid" 2>/dev/null; then
            logger -t "$SCRIPT_NAME" -p user.err "Another instance already running (PID: $lock_pid)"
            exit 1
        else
            logger -t "$SCRIPT_NAME" -p user.warning "Found stale lock file, removing"
            rm -f "$LOCK_FILE"
        fi
    fi
    echo $$ > "$LOCK_FILE"
    logger -t "$SCRIPT_NAME" -p user.info "Lock acquired (PID: $$)"
}

# Function to release lock
release_lock() {
    [ -f "$LOCK_FILE" ] && rm -f "$LOCK_FILE"
}

# Trap to ensure lock is released on exit
trap release_lock EXIT

# Acquire lock at the start
acquire_lock


# Check if remote host is available
logger -t "$SCRIPT_NAME" -p user.info "Checking remote host $REMOTE_HOST"
if ! ssh -o ConnectTimeout=10 -o BatchMode=yes "$REMOTE_USER@$REMOTE_HOST" "echo 'Host is reachable'" &>/dev/null; then
    logger -t "$SCRIPT_NAME" -p user.err "Could not connect to remote host $REMOTE_HOST"
    exit 1
fi

logger -t "$SCRIPT_NAME" -p user.info "Starting Syncoid backup"
logger -t "$SCRIPT_NAME" -p user.info "Checking for pools: ${POSSIBLE_POOLS[*]}"

for current_pool in "${POSSIBLE_POOLS[@]}"; do
    logger -t "$SCRIPT_NAME" -p user.info "Checking pool '$current_pool'"

    if ! ssh "$REMOTE_USER@$REMOTE_HOST" "$ZPOOL list -H $current_pool" &> /dev/null; then

        if ssh "$REMOTE_USER@$REMOTE_HOST" "$ZPOOL import -d /dev/disk/by-uuid/ $current_pool" &>/dev/null; then
            logger -t "$SCRIPT_NAME" -p user.info "Successfully imported pool '$current_pool'"
        else
            logger -t "$SCRIPT_NAME" -p user.warning "Failed to import pool '$current_pool', skipping"
            continue
        fi
    fi

    # Check if pool is online
    if ssh "$REMOTE_USER@$REMOTE_HOST" "$ZPOOL status $current_pool | grep -q 'state: ONLINE'"; then
        logger -t "$SCRIPT_NAME" -p user.info "Pool '$current_pool' is ONLINE"

        logger -t "$SCRIPT_NAME" -p user.info "Loading ZFS key for pool '$current_pool'"
        if ! ssh "$REMOTE_USER@$REMOTE_HOST" "$ZFS load-key -r $current_pool" &>/dev/null; then
            logger -t "$SCRIPT_NAME" -p user.err "Failed to load ZFS key for '$current_pool'"
            exit 1
        fi

        for current_dataset in "${DATASETS_TO_BACKUP[@]}"; do
            logger -t "$SCRIPT_NAME" -p user.info "Backing up dataset '$current_dataset' to '$current_pool'"

            if /usr/sbin/syncoid --no-sync-snap -r "$PROXMOX_DATASET/$current_dataset" "$REMOTE_USER@$REMOTE_HOST:$current_pool/$BACKUP_DATASET/$current_dataset" 2>&1 | logger -t "$SCRIPT_NAME" -p user.info; then
                logger -t "$SCRIPT_NAME" -p user.info "Backup of '$current_dataset' to '$current_pool' completed"
            else
                logger -t "$SCRIPT_NAME" -p user.err "Backup of '$current_dataset' to '$current_pool' failed"
                exit 1
            fi
        done

        logger -t "$SCRIPT_NAME" -p user.info "Exporting pool '$current_pool'"
        if ssh "$REMOTE_USER@$REMOTE_HOST" "$ZPOOL export $current_pool" &>/dev/null; then
            logger -t "$SCRIPT_NAME" -p user.info "Pool '$current_pool' exported successfully"
        else
            logger -t "$SCRIPT_NAME" -p user.warning "Failed to export pool '$current_pool'"
        fi

        logger -t "$SCRIPT_NAME" -p user.info "Successfully processed pool '$current_pool'"
    else
        logger -t "$SCRIPT_NAME" -p user.warning "Pool '$current_pool' is not ONLINE, skipping"
    fi
done

logger -t "$SCRIPT_NAME" -p user.info "Syncoid backup completed successfully"
