#!/bin/bash
#
# Docker Compose auto-update script.
# Logs to systemd journal for Grafana/Loki.
# This script is managed by Ansible.

SCRIPT_NAME="{{ docker_auto_update_script_name }}"

logger -t "$SCRIPT_NAME" -p user.info "Starting Docker auto-update"

docker_auto_update_compose_paths=(
{% for path in docker_auto_update_compose_paths -%}
  "{{ path }}"
{% endfor -%}
)

SUCCESS_COUNT=0
FAILURE_COUNT=0
FAILED_APPS=""
UPDATED_APPS=""

if [ "${{ '{#' }}docker_auto_update_compose_paths[@]}" -eq 0 ]; then
    logger -t "$SCRIPT_NAME" -p user.err "No Docker Compose paths configured"
    exit 1
fi

for compose_path in "${docker_auto_update_compose_paths[@]}"; do
    if [ ! -f "$compose_path" ]; then
        logger -t "$SCRIPT_NAME" -p user.err "Docker Compose file not found: $compose_path"
        FAILURE_COUNT=$((FAILURE_COUNT + 1))
        FAILED_APPS="${FAILED_APPS}
- $compose_path (file not found)"
        continue
    fi

    compose_dir=$(dirname "$compose_path")
    app_name=$(basename "$compose_dir")

    logger -t "$SCRIPT_NAME" -p user.info "Processing: $app_name"

    cd "$compose_dir" || {
        logger -t "$SCRIPT_NAME" -p user.err "Could not change to directory: $compose_dir"
        FAILURE_COUNT=$((FAILURE_COUNT + 1))
        FAILED_APPS="${FAILED_APPS}
- $app_name (directory access failed)"
        continue
    }

    logger -t "$SCRIPT_NAME" -p user.info "Running docker compose pull for $app_name"
    if docker compose pull 2>&1 | logger -t "$SCRIPT_NAME" -p user.info; then
        logger -t "$SCRIPT_NAME" -p user.info "Pull successful for $app_name"

        logger -t "$SCRIPT_NAME" -p user.info "Running docker compose up -d for $app_name"
        if docker compose up -d 2>&1 | logger -t "$SCRIPT_NAME" -p user.info; then
            logger -t "$SCRIPT_NAME" -p user.info "Update successful for $app_name"
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            UPDATED_APPS="${UPDATED_APPS}
- $app_name"
        else
            logger -t "$SCRIPT_NAME" -p user.err "docker compose up -d failed for $app_name"
            FAILURE_COUNT=$((FAILURE_COUNT + 1))
            FAILED_APPS="${FAILED_APPS}
- $app_name (compose up failed)"
        fi
    else
        logger -t "$SCRIPT_NAME" -p user.err "docker compose pull failed for $app_name"
        FAILURE_COUNT=$((FAILURE_COUNT + 1))
        FAILED_APPS="${FAILED_APPS}
- $app_name (pull failed)"
    fi
done

logger -t "$SCRIPT_NAME" -p user.info "Docker auto-update completed. Success: $SUCCESS_COUNT, Failures: $FAILURE_COUNT"

if [ "$FAILURE_COUNT" -eq 0 ]; then
    logger -t "$SCRIPT_NAME" -p user.info "All updates completed successfully. Updated apps: $SUCCESS_COUNT"
else
    logger -t "$SCRIPT_NAME" -p user.warning "Completed with errors. Successful: $SUCCESS_COUNT, Failed: $FAILURE_COUNT"
    if [ -n "$FAILED_APPS" ]; then
        logger -t "$SCRIPT_NAME" -p user.warning "Failed apps:${FAILED_APPS}"
    fi
fi

logger -t "$SCRIPT_NAME" -p user.info "Script finished"

exit "$FAILURE_COUNT"
